<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador y Colección de Cartas Pokémon TCG con Firebase</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-container { position: relative; transition: transform 0.3s ease-in-out; }
        .card-container:hover { transform: scale(1.05); }
        .card-image { transition: box-shadow 0.3s ease-in-out; }
        .card-container:hover .card-image { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .in-collection .card-image { box-shadow: 0 0 15px 5px rgba(22, 163, 74, 0.7); border: 2px solid #16A34A; }
        .collection-toggle-btn { position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; border-radius: 50%; background-color: rgba(0, 0, 0, 0.6); color: white; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; border: 2px solid white; cursor: pointer; transition: background-color 0.2s, transform 0.2s; z-index: 10; }
        .collection-toggle-btn:hover { transform: scale(1.1); }
        .collection-toggle-btn.owned { background-color: #16A34A; }
        /* Estilo para deshabilitar campos */
        :disabled { background-color: #e9ecef; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal -->
    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <img src="https://placehold.co/150x60/000000/FFFFFF?text=PokéTCG" alt="Logo de Pokémon TCG" class="mx-auto mb-4 rounded-lg">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Buscador de Cartas Pokémon</h1>
            <p class="text-gray-600 mt-2">Encuentra y gestiona tu colección de cartas del JCC Pokémon.</p>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="mb-6">
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Tu Clave API (X-Api-Key)</label>
                <input type="password" id="apiKey" value="0b793f15-1998-48e4-9cc4-0a9e1b5badf6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="mb-6 text-center">
                 <h2 class="text-lg font-semibold text-gray-800">Mi Colección</h2>
                 <p class="text-2xl font-bold text-blue-600"><span id="collectionCount">0</span> cartas</p>
                 <p id="auth-status" class="text-sm text-red-500 font-semibold mt-2">Por favor, inicia sesión para ver y editar tu colección.</p>
            </div>

            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="pokemonName" class="block text-sm font-medium text-gray-700">Nombre del Pokémon</label>
                    <input type="text" id="pokemonName" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" placeholder="Ej: Pikachu" disabled>
                </div>
                <div>
                    <label for="pokemonType" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="pokemonType" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-white" disabled>
                        <option value="">Cualquiera</option>
                    </select>
                </div>
                <div>
                    <label for="pokemonRarity" class="block text-sm font-medium text-gray-700">Rareza</label>
                    <select id="pokemonRarity" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-white" disabled>
                        <option value="">Cualquiera</option>
                    </select>
                </div>
                <button type="submit" id="searchButton" class="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition duration-300 col-span-1" disabled>
                    Buscar Cartas
                </button>
            </form>
        </div>

        <div id="status" class="text-center my-8">
            <div id="loader" class="loader mx-auto hidden"></div>
            <p id="message" class="text-gray-600 text-lg"></p>
        </div>
        
        <main id="results" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"></main>

    </div>
    
    <!-- SDK de Firebase -->
    <script type="module">
        // Importa las funciones que necesitas de los SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // *********************************************************************************
        // ** IMPORTANTE: Reemplaza este objeto con la configuración de tu proyecto Firebase **
        // *********************************************************************************
const firebaseConfig = {
  apiKey: "AIzaSyBy9NGyELQsS-t59D93EM4geWBwBr56O08",
  authDomain: "pokesnixx.firebaseapp.com",
  projectId: "pokesnixx",
  storageBucket: "pokesnixx.firebasestorage.app",
  messagingSenderId: "226747705445",
  appId: "1:226747705445:web:9c9d5d858c52a9c8e13e8c",
  measurementId: "G-EX07BC6EX4"
};


        // --- INICIALIZACIÓN DE FIREBASE Y VARIABLES GLOBALES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let userCardCollection = new Set(); // Mantiene una copia local de la colección para acceso rápido
        let unsubscribeFromCollection; // Para detener el listener de Firestore al cerrar sesión

        // --- SELECCIÓN DE ELEMENTOS DEL DOM ---
        const apiKeyInput = document.getElementById('apiKey');
        const searchForm = document.getElementById('searchForm');
        const nameInput = document.getElementById('pokemonName');
        const typeSelect = document.getElementById('pokemonType');
        const raritySelect = document.getElementById('pokemonRarity');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('results');
        const loader = document.getElementById('loader');
        const messageEl = document.getElementById('message');
        const collectionCountEl = document.getElementById('collectionCount');
        const authStatusEl = document.getElementById('auth-status');

        const API_BASE_URL = 'https://api.pokemontcg.io/v2';
        
        // --- MANEJO DE AUTENTICACIÓN ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario ha iniciado sesión
                currentUser = user;
                authStatusEl.textContent = `Sesión iniciada como: ${user.displayName || user.email}`;
                authStatusEl.classList.remove('text-red-500');
                authStatusEl.classList.add('text-green-600');
                enableAppFeatures();
                listenToCollectionChanges();
            } else {
                // Usuario ha cerrado sesión
                currentUser = null;
                authStatusEl.textContent = 'Por favor, inicia sesión para ver y editar tu colección.';
                authStatusEl.classList.add('text-red-500');
                authStatusEl.classList.remove('text-green-600');
                disableAppFeatures();
                if (unsubscribeFromCollection) {
                    unsubscribeFromCollection(); // Detiene el listener anterior
                }
            }
        });

        // --- FUNCIONES DE FIRESTORE ---
        
        /**
         * Escucha cambios en la colección del usuario en tiempo real.
         */
        function listenToCollectionChanges() {
            if (!currentUser) return;
            const collectionRef = doc(db, 'collections', currentUser.uid, 'cards', 'user-collection');
            
            // onSnapshot crea un listener en tiempo real
            unsubscribeFromCollection = onSnapshot(collectionRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Si el documento existe, carga los IDs de las cartas
                    const cardIds = docSnap.data().ids || [];
                    userCardCollection = new Set(cardIds);
                } else {
                    // Si el usuario no tiene colección, empieza una vacía
                    userCardCollection = new Set();
                }
                updateCollectionCount();
                // Re-renderizar las cartas visibles para reflejar el estado actual
                updateDisplayedCardsState(); 
            });
        }

        /**
         * Guarda el set de la colección actual en Firestore.
         */
        async function saveCollectionToFirestore() {
            if (!currentUser) return;
            const collectionRef = doc(db, 'collections', currentUser.uid, 'cards', 'user-collection');
            try {
                // setDoc sobrescribirá el documento con los nuevos datos
                await setDoc(collectionRef, { ids: Array.from(userCardCollection) });
            } catch (error) {
                console.error("Error al guardar la colección en Firestore: ", error);
                messageEl.textContent = 'Error: No se pudo guardar tu colección.';
            }
        }
        
        // --- LÓGICA DE LA APLICACIÓN ---

        function enableAppFeatures() {
            nameInput.disabled = false;
            typeSelect.disabled = false;
            raritySelect.disabled = false;
            searchButton.disabled = false;
            messageEl.textContent = '¡Bienvenido! Busca cartas para añadir a tu colección.';
            // Cargar filtros
            loadDropdownFilters();
        }
        
        function disableAppFeatures() {
            nameInput.disabled = true;
            typeSelect.disabled = true;
            raritySelect.disabled = true;
            searchButton.disabled = true;
            resultsContainer.innerHTML = '';
            messageEl.textContent = '';
            collectionCountEl.textContent = '0';
            userCardCollection.clear();
        }

        async function loadDropdownFilters() {
            // Lógica para cargar filtros (tipos, rarezas) desde la API de Pokémon...
            const [types, rarities] = await Promise.all([
                fetchApiData('types'),
                fetchApiData('rarities')
            ]);
            if (types.length > 0) populateSelect(typeSelect, types);
            if (rarities.length > 0) populateSelect(raritySelect, rarities);
        }

        // ... (el resto de las funciones como fetchApiData, populateSelect, searchForm listener se mantienen similares)
        
        searchForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if(!currentUser) {
                messageEl.textContent = "Debes iniciar sesión para buscar cartas.";
                return;
            }
            // ... (resto de la lógica de búsqueda, sin cambios)
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) { messageEl.textContent = 'Por favor, introduce tu clave API.'; return; }

            resultsContainer.innerHTML = '';
            messageEl.textContent = '';
            loader.classList.remove('hidden');

            let queryParts = [];
            const pokemonName = nameInput.value.trim();
            const pokemonType = typeSelect.value;
            const pokemonRarity = raritySelect.value;

            if (pokemonName) queryParts.push(`name:${pokemonName}*`);
            if (pokemonType) queryParts.push(`types:${pokemonType}`);
            if (pokemonRarity) {
                const rarityQuery = pokemonRarity.includes(' ') ? `"${pokemonRarity}"` : pokemonRarity;
                queryParts.push(`rarity:${rarityQuery}`);
            }

            if (queryParts.length === 0) {
                 messageEl.textContent = 'Introduce al menos un filtro para buscar.';
                 loader.classList.add('hidden');
                 return;
            }
            
            const query = queryParts.join(' ');
            const url = `${API_BASE_URL}/cards?q=${encodeURIComponent(query)}&orderBy=name&pageSize=50`;

            try {
                const response = await fetch(url, { headers: { 'X-Api-Key': apiKey } });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || 'Error en la API.');
                }
                const data = await response.json();
                loader.classList.add('hidden');
                if (data.data && data.data.length > 0) {
                    displayCards(data.data);
                } else {
                    messageEl.textContent = 'No se encontraron cartas que coincidan.';
                }
            } catch (error) {
                console.error('Error durante la búsqueda:', error);
                loader.classList.add('hidden');
                messageEl.textContent = `Ocurrió un error: ${error.message}`;
            }
        });

        function displayCards(cards) {
            resultsContainer.innerHTML = ''; // Limpiar antes de mostrar nuevos resultados
            cards.forEach(card => {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'card-container';
                cardContainer.dataset.cardId = card.id; // Guardar id para re-renderizado

                const cardImage = document.createElement('img');
                cardImage.src = card.images.small;
                cardImage.alt = card.name;
                cardImage.className = 'rounded-lg shadow-md card-image w-full';
                cardImage.onerror = () => { cardImage.src = `https://placehold.co/245x342/_default/FFFFFF?text=${card.name.replace(' ', '+')}`; }

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'collection-toggle-btn';

                updateVisualState(cardContainer, toggleBtn, card.id);

                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (userCardCollection.has(card.id)) {
                        userCardCollection.delete(card.id);
                    } else {
                        userCardCollection.add(card.id);
                    }
                    saveCollectionToFirestore(); // Guarda en Firestore, el listener se encargará de actualizar la UI
                });

                cardContainer.appendChild(toggleBtn);
                cardContainer.appendChild(cardImage);
                resultsContainer.appendChild(cardContainer);
            });
        }

        /** Actualiza el contador de la colección en la UI */
        function updateCollectionCount() {
            collectionCountEl.textContent = userCardCollection.size;
        }

        /** Actualiza el estado visual de una carta (borde y botón) */
        function updateVisualState(container, button, cardId) {
            if (userCardCollection.has(cardId)) {
                container.classList.add('in-collection');
                button.classList.add('owned');
                button.innerHTML = '&#10003;';
            } else {
                container.classList.remove('in-collection');
                button.classList.remove('owned');
                button.textContent = '+';
            }
        }
        
        /** Recorre las cartas visibles y actualiza su estado visual */
        function updateDisplayedCardsState() {
             const displayedCards = resultsContainer.querySelectorAll('.card-container');
             displayedCards.forEach(cardEl => {
                 const cardId = cardEl.dataset.cardId;
                 const btn = cardEl.querySelector('.collection-toggle-btn');
                 if(cardId && btn) {
                     updateVisualState(cardEl, btn, cardId);
                 }
             });
        }

        // --- Funciones de ayuda para cargar filtros ---
        async function fetchApiData(endpoint) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) return [];
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, { headers: { 'X-Api-Key': apiKey } });
                if (!response.ok) throw new Error(`Error de red al obtener ${endpoint}`);
                const data = await response.json();
                return data.data.sort();
            } catch (error) {
                console.error(`Error al cargar ${endpoint}:`, error);
                return [];
            }
        }
        function populateSelect(selectElement, options) {
            // Limpiar opciones anteriores excepto la primera
            while(selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
        }
    </script>
</body>
</html>
